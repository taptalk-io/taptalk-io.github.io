# Chatbot - Custom Channel Integration

* [Overview](#overview)
* [Inbound Messages and Manage Case](#inbound-messages-and-manage-case)
* [Outbound Messages and Case Updates](#outbound-messages-and-case-updates)

## Overview

This document describes the requirements for development and integration of custom channel for OneTalk.

There are 2 API URLs for custom channel to work:
1. API URL provided by OneTalk (OneTalk URL) which business will use to interact with OneTalk, including managing a case and sending inbound messages to OneTalk.
2. API URL provided by business (Channel URL) to receive event notifications from OneTalk, including outbound messages and case updates.

When creating a custom channel, OneTalk URL will be automatically generated along with a secret key. The secret key is required when sending request to the OneTalk URL. The secret key will also be provided in HTTP header when OneTalk calls the Channel URL, check the value to verify if the request is valid.

To start conversation, business must first create a case in OneTalk and save the created case ID. Business can then forward received inbound messages to the case ID. For more information, see [Inbound Messages and Manage Case](#inbound-messages-and-manage-case).

OneTalk will send outbound messages and case updates to business's Channel URL. For more information, see [Outbound Messages and Case Updates](#outbound-messages-and-case-updates).

## Inbound Messages and Manage Case

* [HTTP Method](#http-method)
* [HTTP Headers](#http-headers)
* [Request Body](#request-body)
* [Response Body](#response-body)

Business can forward inbound messages to a case ID in OneTalk. If an open case is not available yet for the conversation, business must create a new case in OneTalk using the provided OneTalk URL. The created case ID must be saved by the business and must be included when sending inbound messages to OneTalk. A case is valid for a single chat ID, but a chat ID may have multiple open cases.

The following payload types are supported by OneTalk URL:
- `create_case`: Create a new case.
- `close_case`: Close an existing case.
- `messages`: Forward inbound messages to a case.

Specifications for the API request:

### HTTP Method

```
POST
```

### HTTP Headers

| Header     | Description
|:-----------|:--------------------------------------------------------------------------
| Secret-Key | The channel's secret key generated by OneTalk, required on every request.

### Request Body

The request body must be JSON.

| Field         | Type                                       | Description
|:--------------|:-------------------------------------------|:---------------------------------------------------------------
| type          | string                                     | The payload type ("create_case", "close_case", or "messages").
| createCase    | [CreateCase](#createcase)                  | `Optional` Details for new case.
| closeCase     | [CloseCase](#closecase)                    | `Optional` Details for closing a case.
| messages      | array of [InboundMessage](#inboundmessage) | `Optional` The list of inbound messages sent to the channel.

Examples:

```json

{
  "eventType": "create_case",
  "createCase": {...}
}

{
  "eventType": "close_case",
  "closeCase": {...}
}
{
  "eventType": "messages",
  "messages": [{...}]
}
```

#### CreateCase

If the parameter `topicID` is not set or value is 0 and the case is not assigned to any topic yet,
then the case will be automatically assigned to the channel's topic.
In case the channel has multiple topics, then a message containing topic options will be sent to the customer.

If the parameter `agentEmail` is set, the selected agent must be assigned to the case's assigned topic.

| Field       | Type     | Description
|:------------|:---------|:------------------------------------------------------
| topicID     | integer  | `Optional` ID of the topic to handover to. 
| agentEmail  | string   | `Optional` Email address of the agent to handover to.

Example:

```json
{
  "topicID": 123,
  "agentEmail": ""
}
```

#### CloseCase

| Field              | Type    | Description
|:-------------------|:--------|:-------------------------------------------------------------------------------
| caseID             | string  | The case ID to be closed.
| sendClosingMessage | boolean | `Optional` If true, closing message will be sent to the customer if available.

Example:

```json
{
  "caseID": "FBED34A1EF",
  "sendClosingMessage": false
}
```

#### InboundMessage

OneTalk supports 4 basic message types:
- `text`
- `document`
- `image`
- `video`

| Field      | Type                                              | Description
|:-----------|:--------------------------------------------------|:---------------------------------------------------------------
| id         | string                                            | The message ID.
| isFromSelf | boolean                                           | If the message is sent by self.
| sender     | [InboundSender](#inboundsender)                   | `Optional` The sender's information, if not from self.
| timestamp  | long                                              | The message's time, in Unix milliseconds.
| type       | string                                            | The message type.
| text       | [InboundMessageText](#inboundmessagetext)         | `Optional` Details for message type "text".
| document   | [InboundMessageDocument](#inboundmessagedocument) | `Optional` Details for message type "document".
| image      | [InboundMessageMedia](#inboundmessagemedia)       | `Optional` Details for message type "image".
| video      | [InboundMessageMedia](#inboundmessagemedia)       | `Optional` Details for message type "video".
| replyToID  | string                                            | `Optional` Message ID replied by this message.

Examples:

```json
{
  "id": "msg.1234567890xxx",
  "isFromSelf": false,
  "sender": {...},
  "timestamp": 1719934171955,
  "type": "text",
  "text": {
    "body": "Hi, what's your name?"
  },
  "replyToID": "msg.9876543210xyz"
}

{
  "id": "msg.1234567890xxx",
  "isFromSelf": false,
  "sender": {...},
  "timestamp": 1719934171955,
  "type": "document",
  "document": {
    "url": "https://...",
    "filename": "Receipt.pdf",
    "caption": ""
  },
  "replyToID": ""
}

{
  "id": "msg.1234567890xxx",
  "isFromSelf": false,
  "sender": {...},
  "timestamp": 1719934171955,
  "type": "image",
  "image": {
    "url": "https://...",
    "caption": "..."
  },
  "replyToID": ""
}

{
  "id": "msg.1234567890xxx",
  "isFromSelf": false,
  "sender": {...},
  "timestamp": 1719934171955,
  "type": "video",
  "image": {
    "url": "https://...",
    "caption": "..."
  },
  "replyToID": ""
}
```

#### InboundSender

| Field | Type    | Description
|:------|:--------|:--------------------
| id    | string  | The sender ID.
| name  | string  | Name of the sender.

```json
{
  "id": "6281234567890",
  "name": "John Doe"
}
```

#### InboundMessageText

| Field | Type    | Description
|:------|:--------|:--------------------------
| body  | string  | Body of the text message.

```json
{
  "body": "Hi, what's your name?"
}
```

#### InboundMessageDocument

| Field    | Type    | Description
|:---------|:--------|:--------------------------
| url      | string  | The document's file URL.
| filename | string  | The document's file name.
| caption  | string  | The document's caption.

Example:

```json
{
  "url": "https://...",
  "filename": "Receipt.pdf",
  "caption": "..."
}
```

#### InboundMessageMedia

| Field    | Type    | Description
|:---------|:--------|:-------------------------------
| url      | string  | The image or video's file URL.
| caption  | string  | The image or video's caption.

Example:

```json
{
  "url": "https://...",
  "caption": "..."
}
```

### Response Body

The response body will be JSON.

| Field   | Type    | Description
|:--------|:--------|:------------------------------------------
| success | boolean | If the request is processed successfully.
| message | string  | The response message.
| caseID  | string  | The case ID or created case ID.

Examples:

```json
{
  "success": true,
  "message": "case created",
  "caseID": "FBED34A1EF"
}
```

