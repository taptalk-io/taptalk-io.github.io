# Chatbot - Custom Channel Integration

* [Overview](#overview)
* [Inbound Messages and Manage Case](#inbound-messages-and-manage-case)
* [Outbound Messages and Case Updates](#outbound-messages-and-case-updates)

## Overview

This document describes the requirements for development and integration of custom channel for OneTalk.

There are 2 API URLs for custom channel to work:
1. API URL provided by OneTalk (OneTalk URL) which business will use to interact with OneTalk, including managing a case and sending inbound messages to OneTalk.
2. API URL provided by business (Channel URL) to receive event notifications from OneTalk, including outbound messages and case updates.

When creating a custom channel, OneTalk URL will be automatically generated along with a secret key. The secret key is required when sending request to the OneTalk URL. The secret key will also be provided in HTTP header when OneTalk calls the Channel URL, check the value to verify if the request is valid.

To start conversation, business can simply forward received inbound messages to OneTalk. For more information, see [Inbound Messages and Manage Case](#inbound-messages-and-manage-case).

OneTalk will send outbound messages and case updates to business's Channel URL. For more information, see [Outbound Messages and Case Updates](#outbound-messages-and-case-updates).

## Inbound Messages and Manage Case

* [HTTP Method](#http-method)
* [HTTP Headers](#http-headers)
* [Request Body](#request-body)
* [Response Body](#response-body)

OneTalk manages chats/conversations in cases. A case will be tied to a chat ID, and a chat ID can only have 1 open case at a time. Business can simply forward received inbound messages to OneTalk and specify the chat ID. If there is currently no open case for the chat ID, OneTalk will automatically create a new case. Any future messages will be sent to the created case as long as it is still open. Business can also send request to close a case for a chat ID.

The following payload types are supported by OneTalk URL:
- `close_case`: Close an existing case for a chat ID.
- `messages`: Forward inbound messages for a chat ID.

Specifications for the API request:

### HTTP Method

```
POST
```

### HTTP Headers

| Header     | Description
|:-----------|:--------------------------------------------------------------------------
| Secret-Key | The channel's secret key generated by OneTalk, required on every request.

### Request Body

The request body must be JSON.

| Field         | Type                                       | Description
|:--------------|:-------------------------------------------|:---------------------------------------------------------------
| type          | string                                     | The payload type ("create_case", "close_case", or "messages").
| closeCase     | [CloseCase](#closecase)                    | `Optional` Details for closing a case.
| messages      | array of [InboundMessage](#inboundmessage) | `Optional` The list of inbound messages sent to the channel.

Examples:

```json
{
  "eventType": "close_case",
  "closeCase": {...}
}

{
  "eventType": "messages",
  "messages": [{...}]
}
```

#### CloseCase

| Field              | Type    | Description
|:-------------------|:--------|:-------------------------------------------------------------------------------
| chatID             | string  | The chat ID for which the case is to be closed.
| sendClosingMessage | boolean | `Optional` If true, closing message will be sent to the customer if available.

Example:

```json
{
  "chatID": "6281234567890",
  "sendClosingMessage": false
}
```

#### InboundMessage

OneTalk supports 4 basic message types:
- `text`
- `document`
- `image`
- `video`

| Field            | Type                                              | Description
|:-----------------|:--------------------------------------------------|:-------------------------------------------------------
| messageID        | string                                            | The message ID.
| chatID           | string                                            | The chat/conversation ID.
| isFromSelf       | boolean                                           | If the message is sent by self.
| sender           | [InboundSender](#inboundsender)                   | `Optional` The sender's information, if not from self.
| timestamp        | long                                              | The message's time, in Unix milliseconds.
| type             | string                                            | The message type.
| text             | [InboundMessageText](#inboundmessagetext)         | `Optional` Details for message type "text".
| document         | [InboundMessageDocument](#inboundmessagedocument) | `Optional` Details for message type "document".
| image            | [InboundMessageMedia](#inboundmessagemedia)       | `Optional` Details for message type "image".
| video            | [InboundMessageMedia](#inboundmessagemedia)       | `Optional` Details for message type "video".
| replyToMessageID | string                                            | `Optional` Message ID replied by this message.

Examples:

```json
{
  "messageID": "msg.1234567890xxx",
  "chatID": "6281234567890",
  "isFromSelf": false,
  "sender": {...},
  "timestamp": 1719934171955,
  "type": "text",
  "text": {
    "body": "Hi, can you help me?"
  },
  "replyToMessageID": "msg.9876543210xyz"
}

{
  "messageID": "msg.1234567890xxx",
  "chatID": "6281234567890",
  "isFromSelf": false,
  "sender": {...},
  "timestamp": 1719934171955,
  "type": "document",
  "document": {
    "url": "https://...",
    "filename": "Receipt.pdf",
    "caption": ""
  },
  "replyToMessageID": ""
}

{
  "messageID": "msg.1234567890xxx",
  "chatID": "6281234567890",
  "isFromSelf": false,
  "sender": {...},
  "timestamp": 1719934171955,
  "type": "image",
  "image": {
    "url": "https://...",
    "caption": "..."
  },
  "replyToMessageID": ""
}

{
  "messageID": "msg.1234567890xxx",
  "chatID": "6281234567890",
  "isFromSelf": false,
  "sender": {...},
  "timestamp": 1719934171955,
  "type": "video",
  "image": {
    "url": "https://...",
    "caption": "..."
  },
  "replyToMessageID": ""
}
```

#### InboundSender

| Field | Type    | Description
|:------|:--------|:--------------------
| id    | string  | The sender ID.
| name  | string  | Name of the sender.

```json
{
  "id": "6281234567890",
  "name": "John Doe"
}
```

#### InboundMessageText

| Field | Type    | Description
|:------|:--------|:--------------------------
| body  | string  | Body of the text message.

```json
{
  "body": "Hi, can you help me?"
}
```

#### InboundMessageDocument

| Field    | Type    | Description
|:---------|:--------|:--------------------------
| url      | string  | The document's file URL.
| filename | string  | The document's file name.
| caption  | string  | The document's caption.

Example:

```json
{
  "url": "https://...",
  "filename": "Receipt.pdf",
  "caption": "..."
}
```

#### InboundMessageMedia

| Field    | Type    | Description
|:---------|:--------|:-------------------------------
| url      | string  | The image or video's file URL.
| caption  | string  | The image or video's caption.

Example:

```json
{
  "url": "https://...",
  "caption": "..."
}
```

### Response Body

The response body will be JSON.

| Field   | Type    | Description
|:--------|:--------|:------------------------------------------
| success | boolean | If the request is processed successfully.
| message | string  | The response message.

Examples:

```json
{
  "success": true,
  "message": ""
}
```
